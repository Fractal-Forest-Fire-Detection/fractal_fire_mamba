<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>National Fire Monitoring Service | Fractal Fire Mamba</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
  <header class="gov-header">
    <div class="gov-brand">
      <span class="gov-logo">Official Service</span>
      <h1 class="gov-title">Fractal Fire Mamba Monitoring Portal</h1><br>
    </div>
    <div id="threatBadge" class="status-indicator status--normal">
      NORMAL OPERATIONS
    </div>
  </header>

  <div class="main-layout">
    <!-- LEFT SIDEBAR: Controls & Status -->
    <aside class="sidebar scroll-panel">
      <section class="card">
        <h2 class="card-title">üêù The Hive ‚Äî Node Map</h2>
        <select id="nodeSelector" class="gov-select">
          <option value="ALL">üåè All Regions</option>
          <!-- Populated dynamically from /api/mesh -->
        </select>
      </section>

      <section class="card">
        <h2 class="card-title">Current Risk Assessment</h2>
        <div class="phase-box">
          <div class="phase-dot" id="phaseDot"></div>
          <span id="activePhase">Monitoring</span>
          <div class="risk-score" id="finalRiskDisplay">0.00</div>
        </div>
        <div class="data-row">
          <span class="label">Risk Tier:</span>
          <span class="value" id="riskTier">Low</span>
        </div>
        <div class="data-row">
          <span class="label">System Confidence:</span>
          <span class="value" id="temporalConf">98%</span>
        </div>
      </section>

      <section class="card">
        <h2 class="card-title">Analysis Weights</h2>
        <div class="bar-group">
          <label>Visual Analysis</label>
          <div class="bar">
            <div class="fill" id="wVisBar" style="width:33%"></div>
          </div>
        </div>
        <div class="bar-group">
          <label>Mamba Thermal SSM</label>
          <div class="bar">
            <div class="fill" id="wThermBar" style="width:33%"></div>
          </div>
        </div>
        <div class="bar-group">
          <label>Chemical Signatures</label>
          <div class="bar">
            <div class="fill" id="wChemBar" style="width:33%"></div>
          </div>
        </div>
      </section>

      <div class="card alerts-card">
        <h2 class="card-title">System Alerts</h2>
        <div class="alert-controls">
          <button class="gov-btn doc-btn" id="downloadCsv">CSV</button>
        </div>
        <div id="alertsList">
          <p style="color:var(--text-secondary)">No alerts yet</p>
        </div>
      </div>
    </aside>

    <!-- CENTER PANEL: Map & Telemetry -->
    <main class="center-panel">
      <div class="card map-card">
        <div class="card-header-overlay">
          <h2 class="card-title">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Tactical Geographic View</h2>
          <button class="gov-btn btn-danger" id="focusLatestRed">Focus Alert</button>
        </div>
        <div id="map"></div>
      </div>

      <div class="charts-row">
        <div class="card chart-card">
          <h2 class="card-title">Thermal Stability</h2>
          <div class="chart-container"><canvas id="tempChart"></canvas></div>
        </div>
        <div class="card chart-card">
          <h2 class="card-title">Chem vs Visual</h2>
          <div class="chart-container"><canvas id="chemVisChart"></canvas></div>
        </div>
        <div class="card chart-card full-width">
          <h2 class="card-title">Risk Trend (Fused Multi-Modal)</h2>
          <div class="chart-container"><canvas id="fusedChart"></canvas></div>
        </div>
      </div>
    </main>

    <!-- RIGHT PANEL: Deep Analysis -->
    <aside class="right-panel scroll-panel">
      <!-- THE HIVE: Mesh Network Panel -->
      <div class="card mesh-card">
        <h2 class="card-title">üêù Mesh Network ‚Äî The Hive</h2>
        <canvas id="meshCanvas" width="280" height="220"
          style="border: 1px solid #e2e8f0; border-radius: 4px;"></canvas>
        <div class="mesh-stats">
          <div class="mesh-stat">
            <span class="mesh-stat-label">Nodes</span>
            <span class="mesh-stat-value" id="meshNodeCount">0</span>
          </div>
          <div class="mesh-stat">
            <span class="mesh-stat-label">Routed</span>
            <span class="mesh-stat-value" id="meshMsgCount">0</span>
          </div>
          <div class="mesh-stat">
            <span class="mesh-stat-label">Sat ‚Üë</span>
            <span class="mesh-stat-value" id="meshSatCount">0</span>
          </div>
          <div class="mesh-stat">
            <span class="mesh-stat-label">Aggregated</span>
            <span class="mesh-stat-value" id="meshAggCount">0</span>
          </div>
        </div>
        <div class="mesh-relay-log-header"
          style="font-size: 0.75rem; color: #666; margin-bottom: 4px; padding-left: 2px;">
          Live LoRa/Satellite Hops:
        </div>
        <div id="meshRelayLog" class="mesh-relay-log">
          <p style="color:#999; font-size:0.8rem;">Waiting for relay events‚Ä¶</p>
        </div>
        <!-- LoRa Link Quality Panel -->
        <div style="margin-top: 8px; font-size: 0.75rem; color: #666; padding-left: 2px;">
          LoRa Link Quality (SX1262):
        </div>
        <div id="loraLinkList" style="max-height: 110px; overflow-y: auto; font-size: 0.75rem; margin-top: 2px;">
          <p style="color:#999; font-size:0.75rem;">Scanning links‚Ä¶</p>
        </div>
      </div>

      <div class="card queen-health-card">
        <h2 class="card-title">üëë Queen Health Monitoring</h2>
        <div id="queenHealthList">
          <p style="color:#999; font-size:0.8rem;">Loading Queen status‚Ä¶</p>
        </div>
        <!-- Iridium Satellite Window -->
        <div class="sat-window"
          style="margin-top: 12px; padding: 10px; background: var(--light-bg); border-radius: 4px; border: 1px solid #e0e0e0;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
            <strong style="font-size: 0.8rem; color: var(--navy);">üõ∞Ô∏è Iridium LEO Pass Window</strong>
            <span id="satPassStatus"
              style="font-size: 0.75rem; padding: 2px 8px; border-radius: 3px; background: var(--success); color: white;">IN
              VIEW</span>
          </div>
          <div style="font-size: 0.75rem; color: #555; line-height: 1.6;">
            <div>Constellation: <strong>Iridium NEXT (66 LEO)</strong></div>
            <div>Altitude: <strong>780 km</strong> ¬∑ Inclination: <strong>86.4¬∞</strong></div>
            <div>Pass Interval: <strong>~10 min</strong> ¬∑ Visibility: <strong>~7 min/pass</strong></div>
            <div>Next Pass: <strong id="nextSatPass">‚Äî</strong></div>
            <div>Uplink Latency: <strong id="satLatency">‚Äî</strong></div>
          </div>
        </div>
        <!-- SBD Outbound Queue -->
        <div
          style="margin-top: 10px; padding: 8px; background: #f9fafb; border-radius: 4px; border: 1px solid #e2e8f0;">
          <div style="font-size: 0.75rem; color: var(--navy); font-weight: 600; margin-bottom: 4px;">
            üì® SBD Outbound Queue
          </div>
          <div id="sbdQueue" style="font-size: 0.72rem; max-height: 90px; overflow-y: auto;">
            <p style="color:#999;">No messages queued</p>
          </div>
        </div>
      </div>

      <div class="card analysis-card">
        <h2 class="card-title">Fractal & Chaos Analysis</h2>

        <div style="margin-bottom: 20px;">
          <h3>Hurst Exponent (H)</h3>
          <div style="height:100px; width:100%"><canvas id="hurstChart"></canvas></div>
          <div class="metric-row">
            <span>Val: <strong id="hurstVal">‚Äî</strong></span>
            <div class="progress-bg">
              <div id="hurstBar" class="progress-fill" style="width:0%"></div>
            </div>
            <span id="fractalStatus">WAITING</span>
          </div>
        </div>

        <div style="margin-bottom: 20px;">
          <h3>Lyapunov Exponent (Œª)</h3>
          <div style="height:100px; width:100%"><canvas id="lyapunovChart"></canvas></div>
          <div class="metric-row">
            <span>Val: <strong id="lyapVal">‚Äî</strong></span>
            <div class="progress-bg">
              <div id="lyapBar" class="progress-fill" style="width:0%"></div>
            </div>
            <span id="chaosStatus">WAITING</span>
          </div>
        </div>

        <!-- SATELLITE TRIGGER BUTTON -->
        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
            <button id="btnSatTrigger" class="gov-btn btn-danger" style="width:100%">üõ∞Ô∏è INGEST SATELLITE FEED</button>
        </div>
      </div>
    </aside>
  </div>

  <!-- SATELLITE ANALYSIS MODAL -->
  <div id="satModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <span class="close-modal">&times;</span>
        <h2 class="gov-title" style="margin-bottom:10px;">üõ∞Ô∏è Satellite Intelligence Feed</h2>
        
        <div style="display:flex; gap:20px; align-items:flex-start;">
            <!-- Left: Image -->
            <div style="flex:1;">
                <img id="satImage" src="" style="width:100%; border-radius:4px; border:2px solid var(--navy);" />
                <div style="margin-top:5px; font-size:0.8rem; color:#666;" id="satTimestamp">Timestamp: --</div>
            </div>
            
            <!-- Right: Analytics -->
            <div style="flex:1;">
                <h3 style="margin-top:0;">Model Comparison</h3>
                
                <!-- Comparison Box -->
                <div style="background:#f8fafc; padding:15px; border-radius:6px; border:1px solid #e2e8f0;">
                    
                    <!-- CNN ROW -->
                    <div style="margin-bottom:15px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <strong>Standard CNN (MobileNet)</strong>
                            <span id="cnnTime">--s</span>
                        </div>
                        <div class="progress-bg" style="height:8px;">
                            <div id="cnnBar" class="progress-fill" style="width:0%; background:#94a3b8;"></div>
                        </div>
                        <div style="font-size:0.8rem; color:#666; margin-top:2px;">
                            Power Est: <span id="cnnPower">--W</span> | Conf: <span id="cnnConf">--%</span>
                        </div>
                    </div>

                    <!-- MAMBA ROW -->
                    <div>
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <strong style="color:var(--primary);">Fractal Mamba (Ours)</strong>
                            <span id="mambaTime" style="color:var(--primary); font-weight:bold;">--s</span>
                        </div>
                        <div class="progress-bg" style="height:8px;">
                            <div id="mambaBar" class="progress-fill" style="width:0%; background:var(--primary);"></div>
                        </div>
                        <div style="font-size:0.8rem; color:#666; margin-top:2px;">
                            Power Est: <span id="mambaPower">--W</span> | Conf: <span id="mambaConf">--%</span>
                        </div>
                    </div>

                </div>

                <!-- Speedup Badge -->
                <div style="margin-top:20px; text-align:center;">
                    <span style="background:#dcfce7; color:#166534; padding:5px 10px; border-radius:20px; font-weight:bold; font-size:0.9rem;">
                        ‚ö° <span id="speedupFactor">0x</span> FASTER
                    </span>
                </div>

                <div id="satAlertBox" style="margin-top:20px; padding:10px; background:#fef2f2; border:1px solid #fecaca; border-radius:4px; display:none;">
                    <strong style="color:#dc2626;">üî• FIRE DETECTED</strong><br>
                    <span style="font-size:0.9rem;">Coordinates synchronized. Dispatching Drones.</span>
                </div>
            </div>
        </div>
    </div>
  </div>

  <script src="app.js"></script>
</body>

</html>